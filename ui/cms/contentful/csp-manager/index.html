<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CSP Manager - Contentful App</title>
  <script src="https://unpkg.com/contentful-ui-extensions-sdk@4"></script>
  <style>
    body { margin: 0; padding: 16px; min-height: 400px; }
    #app { min-height: 400px; }
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    // Import the CSP Manager web component from your own domain
    import 'https://browser.style/ui/csp-manager/src/index.js';

    // Initialize Contentful App SDK
    if (window.contentfulExtension) {
      try {
        const initResult = window.contentfulExtension.init(async (api) => {
          console.log('Contentful SDK initialized');
          const app = document.getElementById('app');

          // Create the CSP Manager component
          const cspManager = document.createElement('csp-manager');
          cspManager.setAttribute('evaluate', '');
          console.log('CSP Manager component created:', cspManager);

          // Add component to page FIRST (so it can initialize)
          app.appendChild(cspManager);
          console.log('Component appended to DOM');

          // Wait for component to be ready (with longer timeout)
          console.log('Waiting for component to be ready...');
          let componentReady = false;
          try {
            await Promise.race([
              cspManager.ready.then(() => { componentReady = true; }),
              new Promise((_, reject) => setTimeout(() => reject(new Error('Component ready timeout')), 10000))
            ]);
            console.log('Component is ready');
          } catch (error) {
            console.warn('Component ready timeout - will try without initial policy:', error);
          }

          // Only set initial policy if component successfully initialized
          if (componentReady) {
            const currentValue = api.field.getValue();
            console.log('Current value from Contentful:', currentValue);
            if (currentValue && typeof currentValue === 'object' && Object.keys(currentValue).length > 0) {
              try {
                console.log('Setting policy to:', currentValue);
                cspManager.policy = currentValue;
              } catch (err) {
                console.error('Failed to set initial policy:', err);
              }
            }
          }

          // Listen for changes from the component
          cspManager.addEventListener('csp-change', (event) => {
            const { policy, evaluations } = event.detail;

            // Save to Contentful
            api.field.setValue(policy);

            // Validation: block publishing if high-severity issues exist
            if (evaluations) {
              const highSeverityIssues = Object.entries(evaluations)
                .filter(([_, evaluation]) => evaluation.severity === 'high');

              if (highSeverityIssues.length > 0) {
                const totalFindings = highSeverityIssues.reduce(
                  (sum, [_, evaluation]) => sum + evaluation.findings.length, 0
                );
                api.field.setInvalid(`${totalFindings} high-severity security issue(s) detected`);
              } else {
                // Clear validation by setting to valid (false)
                api.field.setInvalid(false);
              }
            }
          });

          // Auto-resize iframe to fit content
          api.window.startAutoResizer();
          console.log('Auto-resizer started');
        });

        // Only call .catch() if init returns a Promise
        if (initResult && typeof initResult.catch === 'function') {
          initResult.catch((error) => {
            console.error('Contentful SDK error:', error);
          });
        }
      } catch (error) {
        console.error('Failed to initialize Contentful SDK:', error);
      }
    } else {
      // If SDK not available (not in Contentful), show component in standalone mode
      const app = document.getElementById('app');
      const cspManager = document.createElement('csp-manager');
      cspManager.setAttribute('evaluate', '');
      app.appendChild(cspManager);
    }
  </script>
</body>
</html>
