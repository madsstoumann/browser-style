<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Web Config CSP - Contentful App</title>
  <script src="https://unpkg.com/contentful-ui-extensions-sdk@4"></script>
  <style>
    body { margin: 0; padding: 16px; min-height: 400px; }
    #app { min-height: 400px; }
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    // Import the CSP web component from browser.style
    import 'https://browser.style/ui/web-config-csp/src/index.js';

    // Initialize Contentful App SDK
    if (window.contentfulExtension) {
      try {
        const initResult = window.contentfulExtension.init(async (api) => {
          console.log('Contentful SDK initialized');
          const app = document.getElementById('app');

          // Wait for the custom element to be defined
          console.log('Waiting for web-config-csp to be defined...');
          await customElements.whenDefined('web-config-csp');
          console.log('web-config-csp is defined');

          // Create the CSP Manager component
          const cspManager = document.createElement('web-config-csp');
          cspManager.setAttribute('evaluate', '');
          console.log('CSP Manager component created:', cspManager);

          // Add component to page (triggers connectedCallback)
          app.appendChild(cspManager);
          console.log('Component appended to DOM');

          // Wait for the component's internal ready promise
          if (cspManager.ready) {
            console.log('Waiting for component ready promise...');
            try {
              await Promise.race([
                cspManager.ready,
                new Promise((_, reject) => setTimeout(() => reject(new Error('Component ready timeout')), 10000))
              ]);
              console.log('Component is ready');
            } catch (error) {
              console.warn('Component ready timeout:', error);
            }
          }

          // Load initial value from Contentful
          const currentValue = api.field.getValue();
          console.log('Current value from Contentful:', currentValue);
          if (currentValue && typeof currentValue === 'object' && Object.keys(currentValue).length > 0) {
            try {
              console.log('Setting policy to:', currentValue);
              cspManager.policy = currentValue;
            } catch (err) {
              console.error('Failed to set initial policy:', err);
            }
          }

          // Listen for changes from the component
          cspManager.addEventListener('csp-change', (event) => {
            const { policy, evaluations } = event.detail;

            // Save to Contentful
            api.field.setValue(policy);

            // Validation: block publishing if high-severity issues exist
            if (evaluations) {
              const highSeverityIssues = Object.entries(evaluations)
                .filter(([_, evaluation]) => evaluation.severity === 'high');

              if (highSeverityIssues.length > 0) {
                const totalFindings = highSeverityIssues.reduce(
                  (sum, [_, evaluation]) => sum + evaluation.findings.length, 0
                );
                api.field.setInvalid(`${totalFindings} high-severity security issue(s) detected`);
              } else {
                // Clear validation by setting to valid (false)
                api.field.setInvalid(false);
              }
            }
          });

          // Auto-resize iframe to fit content
          api.window.startAutoResizer();
          console.log('Auto-resizer started');
        });

        // Only call .catch() if init returns a Promise
        if (initResult && typeof initResult.catch === 'function') {
          initResult.catch((error) => {
            console.error('Contentful SDK error:', error);
          });
        }
      } catch (error) {
        console.error('Failed to initialize Contentful SDK:', error);
      }
    } else {
      // If SDK not available (not in Contentful), show component in standalone mode
      const app = document.getElementById('app');
      const cspManager = document.createElement('web-config-csp');
      cspManager.setAttribute('evaluate', '');
      app.appendChild(cspManager);
    }
  </script>
</body>
</html>
