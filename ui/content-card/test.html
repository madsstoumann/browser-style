<!DOCTYPE html>
<html lang="en-US" dir="ltr">
<head>
	<title>Content Card - New Custom Elements</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
	<meta name="description" content="HTML is the foundation of the World Wide Web, and it is still the most popular markup language in use today.">
	<meta name="view-transition" content="same-origin">
	
	<script type="importmap">
	{
		"imports": {
			"@browser.style/layout": "../layout/index.js"
		}
	}
	</script>
	<link rel="stylesheet" href="/ui/layout/dist/layout.min.css" blocking="render">
	<link rel="stylesheet" href="index.css" blocking="render">

	<style>
	html {
		interpolate-size: allow-keywords;
		--layout-primary-bg: hsl(220, 20%, 95%);
		--layout-primary-c: hsl(220, 100%, 20%);
		--layout-secondary-bg: hsl(120, 50%, 95%);
		--layout-secondary-c: hsl(120, 50%, 20%);
		--layout-tertiary-bg: #FFE7E0;
	}
	body {
		--layout-bleed-mw: 1024px;
		--layout-mi: 1rem;
		display: grid;
		margin-block: 1rem;
		margin-inline: max(var(--layout-mi), 50cqw - var(--layout-bleed-mw) / 2);
		row-gap: 1rem;
	}
		
		main {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
			gap: 1rem;
			padding: 1rem;
		}

		.primary {  --cc-bg: var(--layout-primary-bg); }
		.secondary { --cc-bg: var(--layout-secondary-bg); }

		article-card[content*="spot"] { --cc-bdrs: .5rem; }
		lay-out[overflow] { --layout-scrollbar-c: #0002 #0000; }

	</style>
</head>
<body>

	<lay-out lg="grid(3c)" col-gap="2" row-gap="2" gap>
		<news-card content="news-11" layout="rows(th-1 21:9 p:1 flip)"></news-card>
		<news-card content="news-2"></news-card>
		<news-card content="news-3" layout="rows(th-2 p:1)"></news-card>
	</lay-out>

	<lay-out lg="columns(1)" bleed col-gap="2" pad-bottom="2" pad-inline="1" pad-top="2" theme="secondary">
		<news-card content="news-4" layout="columns(21:9)" col-gap="2"></news-card>
	</lay-out>

	<news-card content="news-6" layout="columns(21:9 th-2 p:1.5)"></news-card>
	<news-card content="news-7" layout="columns(21:9 th-2 p:1.5 flip)"></news-card>

	<lay-out lg="columns(4)" pad-top="2" pad-bottom="2">
		<article-card content="spot-1" layout="stack(b-c ta-c p:1 3:4 ovl)"></article-card>
		<article-card content="spot-2" layout="stack(c-l ta-c p:1 3:4 ovl)"></article-card>
		<article-card content="spot-3" layout="stack(b-r ta-c p:1 3:4 ovl)"></article-card>
		<article-card content="spot-4" layout="stack(t-c ta-c p:1 3:4 ovl)"></article-card>
	</lay-out>

	<lay-out bleed pad-bottom="2" pad-inline="1" pad-top="2" theme="tertiary">
		<news-card content="news-1" layout="stack(c-l th-2 p:1 w:50)"></news-card>
	</lay-out>

	<lay-out lg="columns(3)" col-gap="2" row-gap="2" gap pad-bottom="2" pad-top="2" subgrid="5">
		<news-card content="news-5"></news-card>
		<news-card content="news-9"></news-card>
		<news-card content="news-13"></news-card>
	</lay-out>

	<news-card content="news-12" layout="p:1.5" class="secondary"></news-card>

	<lay-out md="columns(2)" lg="ratio(66:33)" bleed theme="primary" pad-top="2" pad-bottom="2" col-gap="4">
		<lay-out lg="bento(4a)">
			<article-card content="spot-1" layout="stack(b-c ta-c p:1 1:1 ovl)"></article-card>
			<article-card content="spot-2" layout="stack(t-l ta-c p:1 1:1 ovl)"></article-card>
			<article-card content="spot-3" layout="stack(b-r ta-c p:1 1:1 ovl)"></article-card>
			<article-card content="spot-4" layout="stack(t-c ta-c p:1 1:1 ovl)"></article-card>
		</lay-out>
		<lay-out gap self="start" row-gap="2">
			<news-card content="news-5"></news-card>
			<news-card content="news-9"></news-card>
		</lay-out>
	</lay-out>

	<lay-out md="columns(2)" lg="columns(4)" overflow="preview" pad-top="2" pad-bottom="2">
		<product-card content="product-1"></product-card>
		<product-card content="product-2"></product-card>
		<product-card content="product-3"></product-card>
		<product-card content="product-4"></product-card>
		<product-card content="product-5"></product-card>
		<product-card content="product-6"></product-card>
		<product-card content="product-7"></product-card>
		<product-card content="product-8"></product-card>
	</lay-out>

	<lay-out md="columns(2)" bleed col-gap="2" pad-top="3" pad-bottom="2" row-gap="2" theme="tertiary">
		<recipe-card content="recipe-3"></recipe-card>
		<recipe-card content="recipe-1"></recipe-card>
		<recipe-card content="recipe-2"></recipe-card>
		<recipe-card content="recipe-4"></recipe-card>
	</lay-out>

	<lay-out lg="columns(3)" col-gap="2" row-gap="2" gap pad-bottom="2" pad-top="2">
		<news-card content="news-8"></news-card>
		<news-card content="news-10" layout="rows(p:1 th-2)"></news-card>
		<event-card content="event-1"></event-card>
	</lay-out>
	

	<main></main>

	<script type="module">
		// Import layout srcsets utilities
		import { generateLayoutSrcsets, createLayoutsDataMap, getSrcset } from '@browser.style/layout';
		
		// Import individual card components
		import { setContentForElement } from './base/data-loader.js';
		import { NewsCard } from './cards/NewsCard.js';
		import { ArticleCard } from './cards/ArticleCard.js';
		import { ProductCard } from './cards/ProductCard.js';
		import { RecipeCard } from './cards/RecipeCard.js';
		import { PollCard } from './cards/PollCard.js';
		import { QuoteCard } from './cards/QuoteCard.js';
		import { EventCard } from './cards/EventCard.js';
		import { FaqCard } from './cards/FaqCard.js';
		import { TimelineCard } from './cards/TimelineCard.js';
		import { BusinessCard } from './cards/BusinessCard.js';

		// Custom elements are auto-registered when modules are imported

		async function initializeLayoutSrcsets() {
			try {
				console.log('üîß Loading layout configuration...');
				
				// Load configuration and layout data
				const [config, gridData, columnsData, bentoData, asymmetricalData, ratiosData] = await Promise.all([
					fetch('../layout/config.json').then(r => r.json()),
					fetch('../layout/systems/layouts/grid.json').then(r => r.json()),
					fetch('../layout/systems/layouts/columns.json').then(r => r.json()),
					fetch('../layout/systems/layouts/bento.json').then(r => r.json()),
					fetch('../layout/systems/layouts/asymmetrical.json').then(r => r.json()),
					fetch('../layout/systems/layouts/ratios.json').then(r => r.json())
				]);

				// Store globally for card system to use
				window._layoutSrcsetData = {
					config,
					layoutsData: createLayoutsDataMap({
						'grid.json': gridData,
						'columns.json': columnsData,
						'bento.json': bentoData,
						'asymmetrical.json': asymmetricalData,
						'ratios.json': ratiosData
					})
				};

				// Set srcsets on all lay-out elements
				console.log('üìê Setting layout srcsets...');
				const layoutElements = document.querySelectorAll('lay-out');
				console.log(`üìä Found ${layoutElements.length} lay-out elements`);

				layoutElements.forEach((element, index) => {
					try {
						const srcsets = generateLayoutSrcsets(element, config, window._layoutSrcsetData.layoutsData);
						
						if (srcsets && srcsets !== 'default:100vw') {
							element.setAttribute('srcsets', srcsets);
							console.log(`‚úÖ Set srcsets for lay-out ${index + 1}:`, srcsets);
						} else {
							element.setAttribute('srcsets', 'default:100vw');
							console.log(`‚ÑπÔ∏è  Set fallback srcsets for lay-out ${index + 1}`);
						}
						
						// Set layout data on child elements
						Array.from(element.children).forEach((child, childIndex) => {
							child.setAttribute('data-layout-index', childIndex);
							
							// Set layout data in settings for BaseCard to use
							child.settings; // Triggers _ensureSettingsInitialized()
							child._settings.layoutIndex = childIndex;
							child._settings.layoutSrcsets = srcsets || 'default:100vw';
							
							console.log(`üìç Set layout index ${childIndex} and srcsets "${srcsets}" on child ${childIndex + 1} of lay-out ${index + 1}`);
						});
						
					} catch (error) {
						console.warn(`‚ö†Ô∏è  Failed to generate srcsets for lay-out ${index + 1}:`, error);
						element.setAttribute('srcsets', 'default:100vw');
					}
				});

				console.log('üéâ Layout srcsets complete!');

			} catch (error) {
				console.error('üí• Failed to initialize layout srcsets:', error);
			}
		}

		async function initializeCards() {
			try {
				console.log('üÉè Loading content data...');
				const allData = await fetch('data.json').then(r => r.json());
				console.log(`üìÑ Loaded ${allData.length} content items`);
				
				// Store globally to avoid multiple loads
				window._cardData = allData;

				// Wait for custom elements to be defined
				await Promise.all([
					customElements.whenDefined('news-card'),
					customElements.whenDefined('article-card'),
					customElements.whenDefined('product-card'),
					customElements.whenDefined('recipe-card'),
					customElements.whenDefined('quote-card'),
					customElements.whenDefined('event-card'),
					customElements.whenDefined('faq-card'),
					customElements.whenDefined('timeline-card'),
					customElements.whenDefined('business-card')
				]);
				console.log('‚úÖ All custom elements defined');

				// Load data for existing cards with content attributes
				const cardSelectors = [
					'news-card[content]',
					'article-card[content]', 
					'product-card[content]',
					'recipe-card[content]',
					'quote-card[content]',
					'event-card[content]',
					'faq-card[content]',
					'timeline-card[content]',
					'business-card[content]'
				];
				
				cardSelectors.forEach(selector => {
					const cards = document.querySelectorAll(selector);
					cards.forEach(card => {
						const contentId = card.getAttribute('content');
						
						setContentForElement(card, contentId, allData);
					});
				});
				
				// Get main container for dynamic cards
				const main = document.querySelector('main');
				
				// Collect all statically defined content IDs to avoid duplicates
				const definedContent = new Set();
				cardSelectors.forEach(selector => {
					Array.from(document.querySelectorAll(selector))
						.forEach(el => definedContent.add(el.getAttribute('content')));
				});

				// Create dynamic cards for remaining data
				let dynamicCardsCreated = 0;
				allData.forEach(item => {
					if (definedContent.has(item.id)) return;
					
					// Map data type to custom element type
					let tagName;
					switch(item.type) {
						case 'news': tagName = 'news-card'; break;
						case 'article':
						case 'spot':
						case 'video':  // Map video to article-card
							tagName = 'article-card'; break;
						case 'poll': tagName = 'poll-card'; break;
						case 'product': tagName = 'product-card'; break;
						case 'recipe': tagName = 'recipe-card'; break;
						case 'quote': tagName = 'quote-card'; break;
						case 'event': tagName = 'event-card'; break;
						case 'faq': tagName = 'faq-card'; break;
						case 'timeline': tagName = 'timeline-card'; break;
						case 'business': tagName = 'business-card'; break;
						default:
							console.warn(`‚ùå Unknown card type: ${item.type} for item: ${item.id}`);
							return;
					}
					
					// Create element using innerHTML (avoids createElement issues)
					const wrapper = document.createElement('div');
					wrapper.innerHTML = `<${tagName} content="${item.id}"></${tagName}>`;
					const cardElement = wrapper.firstElementChild;
					main.appendChild(cardElement);
					
					// Use setContentForElement - layout data already set during initialization
					setContentForElement(cardElement, item.id, allData);
					dynamicCardsCreated++;
					console.log(`‚úÖ Created ${tagName} for ${item.id}`);
				});

				console.log(`üéâ Cards initialized! ${dynamicCardsCreated} dynamic cards created`);

				// Initialize smart popover toggle listeners for YouTube lazy loading and video play/pause
				const { initializePopoverToggleListeners } = await import('./base/utils.js');
				
				// Add a small delay to ensure DOM is fully rendered
				setTimeout(() => {
					initializePopoverToggleListeners();
				}, 100);

			} catch (error) {
				console.error('‚ùå Failed to initialize cards:', error);
			}
		}

		// Add global function to update srcsets for new layout elements
		window.updateLayoutSrcsets = function(container = document) {
			if (!window._layoutSrcsetData) return;
			
			const newLayoutElements = container.querySelectorAll('lay-out:not([srcsets])');
			console.log(`üîÑ Updating srcsets for ${newLayoutElements.length} new lay-out elements`);
			
			newLayoutElements.forEach((element, index) => {
				try {
					const srcsets = generateLayoutSrcsets(element, window._layoutSrcsetData.config, window._layoutSrcsetData.layoutsData);
					if (srcsets && srcsets !== 'default:100vw') {
						element.setAttribute('srcsets', srcsets);
						console.log(`‚úÖ Updated srcsets for new lay-out ${index + 1}:`, srcsets);
					}
					
					// Set layout data on child elements
					Array.from(element.children).forEach((child, childIndex) => {
						child.setAttribute('data-layout-index', childIndex);
						
						// Set layout data in settings for BaseCard to use
						child.settings; // Triggers _ensureSettingsInitialized()
						child._settings.layoutIndex = childIndex;
						child._settings.layoutSrcsets = srcsets || 'default:100vw';
					});
					
				} catch (error) {
					console.warn(`‚ö†Ô∏è  Failed to update srcsets for new lay-out ${index + 1}:`, error);
				}
			});
		};

		// Start the app - layout srcsets first, then cards
		async function startApp() {
			await initializeLayoutSrcsets();
			await initializeCards();
		}
		
		startApp();
	</script>


</body>
</html>