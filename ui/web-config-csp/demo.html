<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Web Config CSP - Demos</title>
	<link rel="stylesheet" href="/base.css">
	<script type="importmap">
		{
			"imports": {
				"@browser.style/web-config-shared": "../web-config-shared/index.js"
			}
		}
	</script>
	<script src="./src/index.js" type="module"></script>
	<style>
		section {
			margin-block: 3rem;
			padding-block-end: 2rem;
			border-bottom: 1px solid #ccc;
		}
		section:last-of-type {
			border-bottom: none;
		}
		.demo-controls {
			display: flex;
			gap: 1rem;
			margin-block: 1rem;
		}
	</style>
</head>
<body>

	<h1>Web Config CSP Demos</h1>
	<p>Various examples demonstrating the Web Config CSP web component features.</p>

	<hr>

	<!-- Demo 1: Initial Policy with Evaluation -->
	<section>
		<h2>1. <code>initial-policy</code> with Evaluation</h2>
		<p>Initialize with a predefined policy and enable security evaluation (note the red borders on unsafe directives).</p>
		<div id="demo1-container"></div>
	</section>

	<!-- Demo 2: From String -->
	<section>
		<h2>2. <code>fromString()</code> Method</h2>
		<p>Parse a CSP string format and load it into the manager with evaluation enabled.</p>
		<div id="demo2-container"></div>
	</section>

	<!-- Demo 3: Get Policy and CSP String -->
	<section>
		<h2>3. <code>policy</code> and <code>cspString</code> Getters</h2>
		<p>Interact with the Web Config CSP below, then use the buttons to retrieve the current policy or copy the CSP string.</p>
		<web-config-csp id="demo3-manager" evaluate></web-config-csp>
		<div class="demo-controls">
			<button id="getPolicyBtn">Get Policy (Console)</button>
			<button id="getCspStringBtn">Copy CSP String to Clipboard</button>
		</div>
	</section>

	<!-- Demo 4: Danish Language with Multiple Severity Levels -->
	<section>
		<h2>4. <code>lang="da"</code> - Danish with Multiple Severity Levels</h2>
		<p>Eksempel på dansk sprog med forskellige sikkerhedsniveauer:</p>
		<ul>
			<li><strong>Høj (rød):</strong> script-src med 'unsafe-inline' og 'unsafe-eval'</li>
			<li><strong>Medium (orange):</strong> style-src med https: wildcard</li>
			<li><strong>Sikker (grøn):</strong> object-src og base-uri</li>
		</ul>
		<div id="demo4-container"></div>
	</section>

	<!-- Demo 5: Event Listener -->
	<section>
		<h2>5. <code>csp-change</code> Event Listener</h2>
		<p>Listen to changes and see the `csp-change` event details in the browser's developer console.</p>
		<p>Try adding or removing directives and values below, then check the console to see the event payload.</p>
		<web-config-csp id="demo5-manager" evaluate></web-config-csp>
	</section>

	<!-- Demo 6: Using HTML Attributes with Inline JSON -->
	<section>
		<h2>6. HTML Attributes (Inline JSON)</h2>
		<p>Custom directive added via inline JSON in the <code>directives</code> attribute.</p>

		<web-config-csp
			id="demo6"
			lang="en"
			directives='{"report-uri": {"defaults": [], "type": "source-list", "enabled": false}}'
			i18n='{"en": {"directives": {"report-uri": "Deprecated. Use report-to instead."}}}'
			evaluate
		></web-config-csp>
	</section>

	<!-- Demo 7: Using JavaScript Setters -->
	<section>
		<h2>7. JavaScript Setters</h2>
		<p>Click the buttons below to dynamically add custom configurations:</p>

		<p id="demo7-controls" class="demo-controls">
			<button id="addDirective">Add Custom Directive</button>
			<button id="addTranslation">Add Translation</button>
			<button id="addRule">Add Evaluation Rule</button>
			<button id="enableCustom">Enable Custom Directive</button>
		</p>

		<web-config-csp id="demo7" lang="en" evaluate></web-config-csp>

		<pre id="output"></pre>
	</section>

	<!-- Demo 8: Complete Custom Configuration -->
	<section>
		<h2>8. Complete Custom Configuration</h2>
		<p>Shows a complete setup with a new directive, translation, and evaluation rule.</p>

		<p class="demo-controls"><button id="setupComplete">Setup Complete Configuration</button></p>

		<web-config-csp id="demo8" lang="en" evaluate></web-config-csp>
	</section>

	<script type="module">
		// Helper function to create and configure a Web Config CSP instance
		function createDemoManager(containerId, options) {
			const container = document.getElementById(containerId);
			if (!container) return;

			const manager = document.createElement('web-config-csp');
			if (options.lang) manager.setAttribute('lang', options.lang);
			if (options.evaluate) manager.setAttribute('evaluate', '');
			if (options.initialPolicy) manager.setAttribute('initial-policy', JSON.stringify(options.initialPolicy));
			if (options.cspString) {
				customElements.whenDefined('web-config-csp').then(() => {
					manager.fromString(options.cspString);
				});
			}

			container.appendChild(manager);
			return manager;
		}

		// Demo 1: Initial Policy with Evaluation
		createDemoManager('demo1-container', {
			evaluate: true,
			initialPolicy: {
				"script-src": { "added": ["'unsafe-inline'", "cdn.example.com"] },
				"style-src": { "added": ["https://fonts.googleapis.com"] },
				"font-src": { "added": ["https://fonts.gstatic.com"] },
				"img-src": { "added": ["https://images.unsplash.com"] },
				"connect-src": { "added": ["api.example.com", "wss://websocket.example.com"] }
			}
		});

		// Demo 2: From String with Evaluation
		createDemoManager('demo2-container', {
			evaluate: true,
			cspString: `
				base-uri 'self';
				default-src 'self';
				frame-ancestors 'none';
				object-src 'none';
				script-src 'self' 'unsafe-inline' 'unsafe-eval' https://example.com;
				style-src 'self' 'unsafe-inline';
			`
		});

		// Demo 3: Policy and CSP String Getters
		const demo3Manager = document.getElementById('demo3-manager');
		document.getElementById('getPolicyBtn').addEventListener('click', () => {
			console.log('Current CSP Policy:', JSON.stringify(demo3Manager.policy, null, 2));
		});
		document.getElementById('getCspStringBtn').addEventListener('click', () => {
			const cspString = demo3Manager.cspString.replace(/&lt;/g, '<').replace(/&gt;/g, '>');
			navigator.clipboard.writeText(cspString).then(() => {
				alert('CSP string copied to clipboard!');
			}).catch(err => console.error('Failed to copy text: ', err));
		});

		// Demo 4: Danish with Multiple Severity Levels
		createDemoManager('demo4-container', {
			lang: 'da',
			evaluate: true,
			initialPolicy: {
				"base-uri": { "added": [] },
				"object-src": { "added": [] },
				"script-src": { "added": ["'unsafe-inline'", "'unsafe-eval'", "https://cdn.example.com"] },
				"style-src": { "added": ["https:", "'unsafe-inline'"] },
				"default-src": { "added": ["https:"] },
				"img-src": { "added": ["data:"] }
			}
		});

		// Demo 5: Event Listener
		const demo5Manager = document.getElementById('demo5-manager');
		demo5Manager.addEventListener('csp-change', (e) => {
			const timestamp = new Date().toLocaleTimeString();
			console.group(`[Web Config CSP] csp-change event at ${timestamp}`);
			console.log('Policy Object:', e.detail.policy);
			console.log('CSP String:', e.detail.cspString);
			if (e.detail.evaluations) {
				console.log('Evaluations:', e.detail.evaluations);
			}
			console.log('Full Event Detail:', e.detail);
			console.groupEnd();
		});

		// --- Merged from config.html ---

		// Wait for custom elements to be defined for the following demos
		await customElements.whenDefined('web-config-csp');

		const demo7 = document.getElementById('demo7');
		const demo8 = document.getElementById('demo8');
		const output = document.getElementById('output');

		// Use event delegation for demo 7 buttons
		const demo7Controls = document.getElementById('demo7-controls');
		if (demo7Controls) {
			demo7Controls.addEventListener('click', (e) => {
				if (e.target.tagName !== 'BUTTON') return;

				const action = e.target.id;
				let message = '';

				switch (action) {
					case 'addDirective':
						demo7.setDirectivesConfig({
							'navigate-to': { defaults: ["'self'"], type: 'source-list', enabled: false }
						});
						message = 'Added "navigate-to" directive to the configuration.';
						break;
					case 'addTranslation':
						demo7.setI18nConfig({
							en: { directives: { 'navigate-to': 'Restricts URLs for navigation (experimental).' } }
						});
						message = 'Added translation for "navigate-to" directive.';
						break;
					case 'addRule':
						demo7.setRulesConfig({
							unsafeKeywords: {
								"'wasm-unsafe-eval'": { severity: 'medium', messageKey: 'eval.wasmWarning', recommendationKey: 'eval.wasmWarningRec' }
							}
						});
						demo7.setI18nConfig({
							en: { eval: { wasmWarning: 'Wasm-unsafe-eval allows WebAssembly compilation', wasmWarningRec: 'Only use if WebAssembly is required' } }
						});
						message = 'Added custom evaluation rule for "wasm-unsafe-eval".';
						break;
					case 'enableCustom':
						demo7.enableDirective('navigate-to');
						message = 'Enabled "navigate-to" directive in the UI.';
						break;
				}
				output.textContent = message;
			});
		}

		// Demo 8: Complete setup
		const setupCompleteBtn = document.getElementById('setupComplete');
		if (setupCompleteBtn) {
			setupCompleteBtn.addEventListener('click', () => {
				demo8.setDirectivesConfig({
					'prefetch-src': { defaults: ["'self'"], type: 'source-list', enabled: true },
					'navigate-to': { defaults: ["'self'"], type: 'source-list', enabled: false }
				});
				demo8.setI18nConfig({
					en: {
						directives: {
							'prefetch-src': 'Specifies valid sources for prefetch and prerendering.',
							'navigate-to': 'Restricts URLs for navigation.'
						},
						eval: {
							prefetchWildcard: 'Wildcard in prefetch-src is risky',
							prefetchWildcardRec: 'Specify trusted origins for prefetch'
						}
					}
				});
				demo8.setRulesConfig({
					scriptStyleDirectives: ['prefetch-src'],
					criticalDirectives: {
						'form-action': { messageKey: 'eval.missingFormAction', recommendationKey: 'eval.missingFormActionRec' }
					}
				});
				demo8.setI18nConfig({
					en: {
						eval: {
							missingFormAction: 'Missing form-action allows form submissions to any URL',
							missingFormActionRec: 'Add form-action to restrict submissions'
						}
					}
				});
				console.log('Complete configuration applied!');
			});
		}

		// Listen to changes
		if (demo7) demo7.addEventListener('csp-change', (e) => console.log('Demo 7 - Policy changed:', e.detail));
		if (demo8) demo8.addEventListener('csp-change', (e) => console.log('Demo 8 - Policy changed:', e.detail));
	</script>

</body>
</html>
