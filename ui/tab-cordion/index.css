/*
 ************************************
 * T A B - C O R D I O N
 ************************************
 *
 * This component is a hybrid of an accordion and a tabs component.
 * - It functions as an accordion by default.
 * - It can be styled in various ways using the `from` attribute with different "tokens".
 * - If a `to` attribute is present, it transforms into a tabs component on wider viewports (>= 700px).
 *
 * It is built using the <details> and <summary> elements for accessibility and semantics.
 *
 */
@import "../icon/index.css";
@scope (tab-cordion) {

	/*
	 ************************************
	 * 1. COMPONENT INITIALIZATION & CUSTOM PROPERTIES
	 ************************************
	 *
	 * We register custom properties for type-safe animations and transitions,
	 * and define all configurable aspects of the component for easy theming.
	 *
	 */
	@property --tab-cordion-index {
		syntax: "<integer>";
		inherits: true;
		initial-value: 1;
	}
	@property --tab-cordion-checked {
		syntax: "<integer>";
		inherits: true;
		initial-value: 0;
	}

		:scope {
		/* Accent Color */
		--tab-cordion-accent: light-dark(hsl(210, 100%, 45%), hsl(210, 100%, 75%));

		/* Borders and Shadows */
		--tab-cordion-bdrs: 1em;
		--tab-cordion-separate-bdrs: 2em;
		
		--tab-cordion-bdc: light-dark(hsl(0 0% 80%), hsl(0 0% 20%));
		--tab-cordion-bdw: 1px;
		--tab-cordion-bxsh: 0 0 1px 0 rgba(0, 0, 0, .07), 0 1px 1px 0 rgba(0, 0, 0, .06), 0 1px 2px 0 rgba(0, 0, 0, .1);
		--tab-cordion-bdc-open: light-dark(hsl(0 0% 60%), hsl(0 0% 40%));
		--tab-cordion-bdw-open: 2px;
		--tab-cordion-bxsh-open: 0 0 2px 0 rgba(0, 0, 0, .14), 0 2px 2px 0 rgba(0, 0, 0, .12), 0 1px 3px 0 rgba(0, 0, 0, .2);

		/* Spacing and Transitions */
		--tab-cordion-gap: 1ch;
		--tab-cordion-item-p: 1.5ch;
		--tab-cordion-tabs-item-p: 2ch;
		--tab-cordion-separate-p: 1.5ch 2ch 1.5ch 3ch;
		--tab-cordion-trsdu: 300ms;
		--tab-cordion-trstf: linear(0, 0.1641 3.52%, 0.311 7.18%, 0.4413 10.99%, 0.5553 14.96%, 0.6539 19.12%, 0.738 23.5%, 0.8086 28.15%, 0.8662 33.12%, 0.9078 37.92%, 0.9405 43.12%, 0.965 48.84%, 0.9821 55.28%, 0.992 61.97%, 0.9976 70.09%, 1);

		/* Background Colors */
		--tab-cordion-bg: light-dark(#EEE, #222);
		--tab-cordion-tabs-bg: light-dark(lightblue, #222);
		--tab-cordion-hover-bg: light-dark(hsl(210, 100%, 95%), hsl(210, 50%, 15%));

		/* Base Styles */
		container-type: inline-size;
		interpolate-size: allow-keywords;
		display: block;
	}

		/*
	 ************************************
	 * 2. CORE LAYOUT & BASE STYLES
	 ************************************
	 *
	 * These are the fundamental styles for the component's building blocks.
	 *
	 */

	cq-box {
		corner-shape: superellipse(1.25);
		display: grid;
	}

	details {
		--tab-cordion-index: sibling-index();
		/* The translate offset is driven by breakout-specific tokens that update --_y. */
		background: var(--tab-cordion-item-bg, Canvas);
		translate: 0 calc(var(--_y) * 1rem);
		transition: translate var(--tab-cordion-trsdu) ease;
		/* --- Open State --- */
		&[open]::details-content {
			block-size: auto;
			content-visibility: visible;
		}
	}

	summary {
		color: var(--tabs-group-c, inherit);
		cursor: pointer;
		display: flex;
		font-family: var(--tab-cordion-ff, inherit);
		font-size: var(--tab-cordion-fs, inherit);
		grid-column: var(--tab-cordion-index);
		grid-row: 1;
		/* Pin each summary to its index column so tabs align when converted. */
		justify-content: space-between;
		list-style: none;
		padding: var(--tab-cordion-item-p);
		position: relative;
		user-select: none;
		text-box: cap alphabetic;
		transition: background-color .2s ease;
	}

	summary::marker,
	summary::-webkit-details-marker {
		display: none;
	}

	ui-icon {
		color: var(--tab-cordion-ui-icon-c, light-dark(#5a5a5a, #b0b0b0));
	}

	/*
	 ************************************
	 * 3. ACCORDION VARIANTS (`from` attribute)
	 ************************************
	 *
	 * These styles are applied based on the "tokens" in the `from` attribute,
	 * allowing for different visual presentations of the accordion.
	 *
	 */

	/* --- background (mobile/accordion) --- */
	:scope[from~="background"] {
		cq-box {
			background: var(--tab-cordion-bg);
			padding: var(--tab-cordion-p, 1.5ch);
		}
	}

	/* --- `breakout` variant --- */
	/* The open item visually "breaks out" from the stack by translating
	 * subsequent items downwards. The `--_y` custom property controls the vertical translation amount. */
	:scope[from~="breakout"] {
		details {
			/* Adds a border between the open item and the one immediately following it. */
			&[open] + details {
				border-block-start: var(--tab-cordion-bdw) solid var(--tab-cordion-bdc);
			}
		}
		/* The open item gets a distinct border. */
		[open] {
			border: var(--tab-cordion-bdw-open, inherit) solid var(--tab-cordion-bdc-open, inherit);
		}
		/* The item immediately after the open one is pushed down by 1 unit. */
		[open]:not(:first-of-type),
		[open]:first-of-type ~ details { --_y: 1; }
		/* All items after that are pushed down by 2 units. */
		[open] ~ details { --_y: 2; }

		/* --- `elevated` sub-variant (used with `breakout`) --- */
		/* This replaces the `breakout` border with a box-shadow for a "floating" effect. */
		&[from~="elevated"] {
			--tab-cordion-bdw-open: 0px; /* Remove the border from the open item */
			[open] {
				box-shadow: var(--tab-cordion-bxsh-open);
			}
			/* Apply a smaller shadow to the last item or the item just before an open one. */
			details {
				&:last-of-type:not([open]),
				&:has(+ details[open]) {
					box-shadow: var(--tab-cordion-bxsh);
				}
			}
		}
	}

	/* --- `separate` variant --- */
	/* Adds vertical space and a border around each individual accordion item, making them appear as distinct cards. */
	:scope[from~="separate"] {
		cq-box {
			row-gap: var(--tab-cordion-gap);
		}
		details {
			--_y: 0; /* Resets the breakout translation */
			border: var(--tab-cordion-bdw) solid var(--tab-cordion-bdc);
		}
		/* Explicitly disable the breakout translation effect when `separate` is also used. */
		&[from~="breakout"] {
			[open],
			[open]:first-of-type ~ details,
			[open] ~ details {
				--_y: 0;
			}
		}
	}

	/* --- `contain` variant --- */
	/* Wraps the entire accordion group in a single continuous border, making it look like a unified block. */
	:scope[from~="contain"] {
		details {
			border-inline: var(--tab-cordion-bdw) solid var(--tab-cordion-bdc);
		}
		/* Apply top border to the first item. */
		&:not([from~="breakout"]) {
			details {
				&:first-of-type {
					border-block-start: var(--tab-cordion-bdw) solid var(--tab-cordion-bdc);
				}
			}
		}
		/* In breakout mode, only apply top border if the first item is closed. */
		&[from~="breakout"] {
			details {
				&:first-of-type:not([open]) {
					border-block-start: var(--tab-cordion-bdw) solid var(--tab-cordion-bdc);
				}
			}
		}
		/* Apply bottom border to the last item, but only if items are not already divided. */
		&:not([from~="divided"]) {
			details {
				&:last-of-type {
					border-block-end: var(--tab-cordion-bdw) solid var(--tab-cordion-bdc);
				}
			}
		}
	}

	/* --- `divided` variant --- */
	/* Adds a border line between each accordion item. */
	:scope[from~="divided"] {
		details {
			border-block-end: var(--tab-cordion-bdw) solid var(--tab-cordion-bdc);
		}
	}

	/* --- `rounded` variant --- */
	/* Applies border-radius to the accordion items for a softer look. */
	:scope[from~="rounded"] {

		/* Default rounding for non-breakout layout: rounds the top of the first item and bottom of the last. */
		&:not([from~="breakout"]) {
			details {
				&:first-of-type,
				&:first-of-type summary {
					border-top-left-radius: var(--tab-cordion-bdrs);
					border-top-right-radius: var(--tab-cordion-bdrs);
				}
				&:last-of-type,
				&:last-of-type summary {
					border-bottom-left-radius: var(--tab-cordion-bdrs);
					border-bottom-right-radius: var(--tab-cordion-bdrs);
				}
			}
		}

		/* With breakout: border-radius is applied dynamically based on which item is open. */
		&[from~="breakout"] {
			details {
				/* Round the top corners of the first item and the item after an open one. */
				&:first-of-type,
				&[open] + details,
				&[open] + details summary {
					border-top-left-radius: var(--tab-cordion-bdrs);
					border-top-right-radius: var(--tab-cordion-bdrs);
				}
				/* Round the bottom corners of the last item and the item before an open one. */
				&:last-of-type,
				&:has(+ details[open]),
				&:has(+ details[open]) summary {
					border-bottom-left-radius: var(--tab-cordion-bdrs);
					border-bottom-right-radius: var(--tab-cordion-bdrs);
				}
			}
			/* The open item itself is fully rounded. */
			[open] {
				border-radius: var(--tab-cordion-bdrs);
			}
		}

		/* When separate, each item is fully rounded, like individual cards. */
		&[from~="separate"] {
			details,
			details summary {
				--tab-cordion-bdrs: var(--tab-cordion-separate-bdrs);
				border-radius: var(--tab-cordion-separate-bdrs);
			}
			details {
				--tab-cordion-item-p: var(--tab-cordion-separate-p);
			}
		}
	}

	/*
	 ************************************
	 * 4. STATE, CONTENT & TRANSITIONS
	 ************************************
	 *
	 * Manages the open/closed state of the accordion items, their hover
	 * effects, and the visibility transitions for their content.
	 *
	 */

	@media (hover: hover) {
		details:hover:not([open]) {
			background: var(--tab-cordion-hover-bg, light-dark(hsl(210, 100%, 95%), hsl(210, 50%, 15%)));
		}
	}

	&:not([to]) details::details-content {
		block-size: 0;
		content-visibility: hidden;
		overflow: hidden;
		transition: block-size var(--tab-cordion-trsdu), content-visibility var(--tab-cordion-trsdu);
		transition-behavior: allow-discrete;
	}

	@container (width <= 700px) {
		details::details-content {
			block-size: 0;
			content-visibility: hidden;
			overflow: hidden;
			transition: block-size var(--tab-cordion-trsdu), content-visibility var(--tab-cordion-trsdu);
			transition-behavior: allow-discrete;
		}
	}

	/*
	 ************************************
	 * 5. TABS TRANSFORMATION (`to` attribute)
	 ************************************
	 *
	 * When the `to` attribute is present and the container is wide enough (>= 700px),
	 * the component transforms into a tabbed interface. This section primarily handles
	 * resetting the accordion styles from the `from` variants to a neutral state
	 * before the main tab styles are applied.
	 *
	 */
	:scope[to] {
		@container (width >= 700px) {

			cq-box {
				--tab-cordion-gap: var(--tab-cordion-desktop-gap, 2ch);
				grid-template-columns: repeat(var(--tab-cordion-tabs, 6), 1fr);
				grid-template-rows: auto 1fr;
				isolation: isolate;
				position: relative;
				row-gap: 0;
				&::after {
					background: var(--tab-cordion-item-bg-active, light-dark(#EEE, #333));
					content: "";
					display: block;
					grid-row: 1;
					position: absolute;
					inset-block-start: 0;
					inset-inline-start: anchor(--tab-active left);
					/* Sliding highlight tracks the anchored active summary. */
					inline-size: anchor-size(--tab-active width);
					block-size: anchor-size(--tab-active height);
					transition: inset-inline-start var(--tab-cordion-trsdu) ease, inline-size var(--tab-cordion-trsdu) ease;
				}
			}

			details {
				border: unset;
				border-radius: 0;
				display: grid;
				grid-column: 1 / -1;
				grid-row: 1 / span 2;
				grid-template-columns: subgrid;
				grid-template-rows: subgrid;
				&[open] summary {
					anchor-name: --tab-active;
					/* Anchor name lets the highlight align with whichever tab is open. */
					text-decoration: 3px underline var(--tab-cordion-accent);
				}
			}

			details::details-content {
				grid-column: 1 / -1;
				grid-row: 2;
				/* Ensures the body spans the full tab row beneath the summaries. */
			}

			summary {
				--tab-cordion-item-p: var(--tab-cordion-tabs-item-p);
				justify-self: center;
				z-index: 1;
				text-underline-offset: calc(100% - 3px);
				& + * {  position: relative;  z-index: 1; }
			}

			ui-icon { display: none; } /* TODO ? */
			/* Hide icons on desktop tabs where space is limited. */

			@media (hover: hover) { /* TODO ? */
				/* Disable additional hover growth so the highlight remains visible. */
				details:hover {
					background: #0000;
				}
			}

			/* Unset from background properties when switching to desktop mode */
			&[from~="background"] cq-box {
				background: unset;
				padding: unset;
			}

			/* --- Add main background and reset background properties for tabs --- */
			&[to~="background"] {
				cq-box::before {
					background: var(--tab-cordion-tabs-bg);
					border-radius: 2ch;
					content: "";
					grid-column: 1 / -1;
					grid-row: 1;
				}
				details { background: unset; }
			}

			/* --- Reset `breakout` variant --- */
			&[from~="breakout"] {
				details {
					&[open] + details {
						border-block-start: 0;
					}
					--_y: unset;
				}
				[open] {
					border: 0;
				}
				[open]:not(:first-of-type),
				[open]:first-of-type ~ details,
				[open] ~ details {
					--_y: unset;
				}
			}

			/* --- Reset `elevated` sub-variant --- */
			&[from~="breakout"][from~="elevated"] {
				[open] {
					box-shadow: none;
				}
				details {
					&:last-of-type:not([open]),
					&:has(+ details[open]) {
						box-shadow: none;
					}
				}
			}

			/* --- Reset `contain` variant --- */
			&[from~="contain"] {
				details {
					border-inline: 0;
					&:first-of-type {
						border-block-start: 0;
					}
					&:first-of-type:not([open]) {
						border-block-start: 0;
					}
					&:last-of-type {
						border-block-end: 0;
					}
				}
			}

			/* --- Reset `divided` variant --- */
			&[from~="divided"] {
				details {
					border-block-end: 0;
				}
			}

			/* --- Reset `rounded` variant --- */
			&[from~="rounded"] {
				details {
					border-radius: 0;
					&:first-of-type,
					&:first-of-type summary,
					&:last-of-type,
					&:last-of-type summary,
					&[open] + details,
					&[open] + details summary,
					&:has(+ details[open]),
					&:has(+ details[open]) summary {
						border-top-left-radius: 0;
						border-top-right-radius: 0;
						border-bottom-left-radius: 0;
						border-bottom-right-radius: 0;
					}
				}
				[open] {
					border-radius: 0;
				}
			}

			/* --- Reset `separate` variant --- */
			&[from~="separate"] {
				cq-box {
					row-gap: 0;
				}
				details {
					--_y: unset;
					border: 0;
				}
			}
		}
	}

	/*
	 ************************************
	 * 6. STATE PROPAGATION
	 ************************************
	 *
	 * Set `--tab-cordion-tabs` on the `cq-box` parent.
	 * This "bubbles up" state from children to a parent for use in other selectors.
	 * This is limited to 10 items but can be extended.
	*/

	/* Each of these locators counts tab items. Extend beyond 10 if needed. */
	cq-box:has(> details:nth-child(1):last-child) { --tab-cordion-tabs: 1; }
	cq-box:has(> details:nth-child(2):last-child) { --tab-cordion-tabs: 2; }
	cq-box:has(> details:nth-child(3):last-child) { --tab-cordion-tabs: 3; }
	cq-box:has(> details:nth-child(4):last-child) { --tab-cordion-tabs: 4; }
	cq-box:has(> details:nth-child(5):last-child) { --tab-cordion-tabs: 5; }
	cq-box:has(> details:nth-child(6):last-child) { --tab-cordion-tabs: 6; }
	cq-box:has(> details:nth-child(7):last-child) { --tab-cordion-tabs: 7; }
	cq-box:has(> details:nth-child(8):last-child) { --tab-cordion-tabs: 8; }
	cq-box:has(> details:nth-child(9):last-child) { --tab-cordion-tabs: 9; }
	cq-box:has(> details:nth-child(10):last-child) { --tab-cordion-tabs: 10; }
}