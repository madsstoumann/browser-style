/*
 ************************************
 * T A B - C O R D I O N
 ************************************
 *
 * This component is a hybrid of an accordion and a tabs component.
 * - It functions as an accordion by default.
 * - It can be styled in various ways using the `from` attribute with different "tokens".
 * - If a `to` attribute is present, it transforms into a tabs component on wider viewports (>= 700px).
 *
 * It is built using the <details> and <summary> elements for accessibility and semantics.
 *
 */
@import "../icon/index.css";

@scope (tab-cordion) {

	/*
	 ************************************
	 * 1. COMPONENT INITIALIZATION & CUSTOM PROPERTIES
	 ************************************
	 *
	 * We register custom properties for type-safe animations and transitions,
	 * and define all configurable aspects of the component for easy theming.
	 *
	 */
	@property --tab-cordion-index {
		syntax: "<integer>";
		inherits: true;
		initial-value: 1;
	}
	@property --tab-cordion-checked {
		syntax: "<integer>";
		inherits: true;
		initial-value: 0;
	}

		:scope {
		/* Accent Color */
		--tc-accent: light-dark(hsl(210, 100%, 45%), hsl(210, 100%, 75%));

		/* Borders and Shadows */
		--tc-item-bdrs: 1em;
		--tc-item-bdrs-separate: 2em;
		--tc-item-bdc: light-dark(hsl(0 0% 80%), hsl(0 0% 30%));
		--tc-item-bdw: 1px;
		--tc-item-bxsh: 0 0 1px 0 rgba(0, 0, 0, .07), 0 1px 1px 0 rgba(0, 0, 0, .06), 0 1px 2px 0 rgba(0, 0, 0, .1);
		--tc-item-bdc-open: light-dark(hsl(0 0% 60%), hsl(0 0% 40%));
		--tc-item-bdw-open: 2px;
		--tc-item-bxsh-open: 0 0 2px 0 rgba(0, 0, 0, .14), 0 2px 2px 0 rgba(0, 0, 0, .12), 0 1px 3px 0 rgba(0, 0, 0, .2);
		--tc-tabs-bdrs: 3em;
		--tc-tabs-bdw: 4px;
		--tc-tabs-item-bdc: light-dark(#FFF, #000);
		--tc-tabs-item-bdw: 1px;
		--tc-tabs-line-bdw: 3px;
		--tc-tabs-panel-bxsh: 0 8px 18px -12px rgba(0, 0, 0, .35), 0 6px 12px -14px rgba(0, 0, 0, .2);
		--tc-tabs-panel-bxsh-dark: 0 8px 18px -12px rgba(255, 255, 255, .35), 0 6px 12px -14px rgba(255, 255, 255, .35);

		/* Spacing and Transitions */
		--tc-group-rg: 1em;
		--tc-item-p: 1.5ch;
		--tc-item-p-separate: 1.5ch 2.5ch;
		--tc-item-p-tabs: 1.5ch;
		--tc-item-trsdu: 300ms;
		--tc-tabs-gap: 2ch;
		--tc-breakout-unit: 1rem;
	
		/* Background Colors */
		--tc-bg: light-dark(#EEE, #222);
		--tc-tabs-bg: light-dark(#EAEAEA, #222);
		--tc-tabs-panel-bg: light-dark(#f7f7f7, #1c1c1c);
		--tc-item-bg-active: light-dark(rgba(255, 255, 255, .5), rgba(255, 255, 255, .15));
		--tc-hover-bg: light-dark(hsl(210, 100%, 95%), hsl(210, 50%, 15%));

		/* Tab Hover States */
		--tc-tab-hover-c: var(--tc-accent);
		--tc-tab-hover-bg: light-dark(rgba(0,0,0,0.05), rgba(255,255,255,0.1));
		--tc-tab-hover-td: none;

		/* Base Styles */
		container-type: inline-size;
		interpolate-size: allow-keywords;
		display: block;
	}

		/*
	 ************************************
	 * 2. CORE LAYOUT & BASE STYLES
	 ************************************
	 *
	 * These are the fundamental styles for the component's building blocks.
	 *
	 */

	cq-box {
		/* corner-shape: superellipse(1.25); */
		display: grid;
	}

	details {
		/* --tab-cordion-index: sibling-index(); */
		/* The translate offset is driven by breakout-specific tokens that update --_y. */
		background: var(--tab-cordion-item-bg, Canvas);
		translate: 0 calc(var(--_y) * var(--tc-breakout-unit, 1rem));
		transition: translate var(--tc-item-trsdu) ease;
		/* --- Open State --- */
		&[open]::details-content {
			block-size: auto;
			content-visibility: visible;
		}
	}

	summary {
		color: var(--tabs-group-c, inherit);
		cursor: pointer;
		display: flex;
		font-family: var(--tab-cordion-ff, inherit);
		font-size: var(--tab-cordion-fs, inherit);
		grid-column: var(--tab-cordion-index);
		grid-row: 1;
		/* Pin each summary to its index column so tabs align when converted. */
		justify-content: space-between;
		list-style: none;
		padding: var(--tc-item-p);
		position: relative;
		-webkit-user-select: none;
		user-select: none;
		text-box: cap alphabetic;
		transition: background-color .2s ease;
	}

	summary::marker,
	summary::-webkit-details-marker {
		display: none;
	}

	ui-icon {
		color: var(--tab-cordion-ui-icon-c, light-dark(#5a5a5a, #b0b0b0));
	}

	/*
	 ************************************
	 * 3. ACCORDION VARIANTS (`from` attribute)
	 ************************************
	 *
	 * These styles are applied based on the "tokens" in the `from` attribute,
	 * allowing for different visual presentations of the accordion.
	 *
	 */

	/* --- background (mobile/accordion) --- */
	:scope:where([from~="background"]) {
		cq-box {
			background: var(--tc-bg);
			padding: var(--tab-cordion-p, 1.5ch);
		}
	}

	/* --- `breakout` variant --- */
	/* The open item visually "breaks out" from the stack by translating
	 * subsequent items downwards. The `--_y` custom property controls the vertical translation amount. */
	:scope:where([from~="breakout"]) {
		details {
			/* Adds a border between the open item and the one immediately following it. */
			&:where([open] + details) {
				border-block-start: var(--tc-item-bdw) solid var(--tc-item-bdc);
			}
		}
		/* The open item gets a distinct border. */
		:where([open]) {
			border: var(--tc-item-bdw-open, inherit) solid var(--tc-item-bdc-open, inherit);
		}
		/* The item immediately after the open one is pushed down by 1 unit. */
		:where([open]:not(:first-of-type)),
		:where([open]:first-of-type ~ details) { --_y: 1; }
		/* All items after that are pushed down by 2 units. */
		:where([open] ~ details) { --_y: 2; }

		/* --- `elevated` sub-variant (used with `breakout`) --- */
		/* This replaces the `breakout` border with a box-shadow for a "floating" effect. */
		&:where([from~="elevated"]) {
			--tc-item-bdw-open: 0px; /* Remove the border from the open item */
			:where([open]) {
				box-shadow: var(--tc-item-bxsh-open);
			}
			/* Apply a smaller shadow to the last item or the item just before an open one. */
			details {
				&:where(:last-of-type:not([open])),
				&:where(:has(+ details[open])) {
					box-shadow: var(--tc-item-bxsh);
				}
			}
		}
	}

	/* --- `separate` variant --- */
	/* Adds vertical space and a border around each individual accordion item, making them appear as distinct cards. */
	:scope:where([from~="separate"]) {
		cq-box {
			row-gap: var(--tc-group-rg);
		}
		details {
			--_y: 0; /* Resets the breakout translation */
			border: var(--tc-item-bdw) solid var(--tc-item-bdc);
		}
		/* Explicitly disable the breakout translation effect when `separate` is also used. */
		&:where([from~="breakout"]) {
			:where([open]),
			:where([open]:first-of-type ~ details),
			:where([open] ~ details) {
				--_y: 0;
			}
		}
	}

	/* --- `contain` variant --- */
	/* Wraps the entire accordion group in a single continuous border, making it look like a unified block. */
	:scope:where([from~="contain"]) {
		details {
			border-inline: var(--tc-item-bdw) solid var(--tc-item-bdc);
		}
		/* Apply top border to the first item. */
		&:where(:not([from~="breakout"])) {
			details {
				&:first-of-type {
					border-block-start: var(--tc-item-bdw) solid var(--tc-item-bdc);
				}
			}
		}
		/* In breakout mode, only apply top border if the first item is closed. */
		&:where([from~="breakout"]) {
			details {
				&:first-of-type:not([open]) {
					border-block-start: var(--tc-item-bdw) solid var(--tc-item-bdc);
				}
			}
		}
		/* Apply bottom border to the last item, but only if items are not already divided. */
		&:where(:not([from~="divided"])) {
			details {
				&:last-of-type {
					border-block-end: var(--tc-item-bdw) solid var(--tc-item-bdc);
				}
			}
		}
	}

	/* --- `divided` variant --- */
	/* Adds a border line between each accordion item. */
	:scope:where([from~="divided"]) {
		details {
			border-block-end: var(--tc-item-bdw) solid var(--tc-item-bdc);
		}
	}

	/* --- `rounded` variant --- */
	/* Applies border-radius to the accordion items for a softer look. */
	:scope:where([from~="rounded"]) {

		/* Default rounding for non-breakout layout: rounds the top of the first item and bottom of the last. */
		&:where(:not([from~="breakout"])) {
			details {
				&:first-of-type,
				&:first-of-type summary {
					border-top-left-radius: var(--tc-item-bdrs);
					border-top-right-radius: var(--tc-item-bdrs);
				}
				&:last-of-type,
				&:last-of-type summary {
					border-bottom-left-radius: var(--tc-item-bdrs);
					border-bottom-right-radius: var(--tc-item-bdrs);
				}
			}
		}

		/* With breakout: border-radius is applied dynamically based on which item is open. */
		&:where([from~="breakout"]) {
			details {
				/* Round the top corners of the first item and the item after an open one. */
				&:first-of-type,
				&[open] + details,
				&[open] + details summary {
					border-top-left-radius: var(--tc-item-bdrs);
					border-top-right-radius: var(--tc-item-bdrs);
				}
				/* Round the bottom corners of the last item and the item before an open one. */
				&:last-of-type,
				&:has(+ details[open]),
				&:has(+ details[open]) summary {
					border-bottom-left-radius: var(--tc-item-bdrs);
					border-bottom-right-radius: var(--tc-item-bdrs);
				}
			}
			/* The open item itself is fully rounded. */
			[open] {
				border-radius: var(--tc-item-bdrs);
			}
		}

		/* When separate, each item is fully rounded, like individual cards. */
		&:where([from~="separate"]) {
			details,
			details summary {
				--tc-item-bdrs: var(--tc-item-bdrs-separate);
				border-radius: var(--tc-item-bdrs-separate);
			}
			details {
				--tc-item-p: var(--tc-item-p-separate);
			}
		}
	}

	/*
	 ************************************
	 * 4. STATE, CONTENT & TRANSITIONS
	 ************************************
	 *
	 * Manages the open/closed state of the accordion items, their hover
	 * effects, and the visibility transitions for their content.
	 *
	 */

	@media (hover: hover) {
		:scope:not([from~="nohover"]) details:hover:not([open]) {
			background: var(--tc-hover-bg, light-dark(hsl(210, 100%, 95%), hsl(210, 50%, 15%)));
		}
	}

	&:not([to]) details::details-content {
		block-size: 0;
		content-visibility: hidden;
		overflow: hidden;
		transition: block-size var(--tc-item-trsdu), content-visibility var(--tc-item-trsdu);
		transition-behavior: allow-discrete;
	}

	@container (width <= 700px) {
		details::details-content {
			block-size: 0;
			content-visibility: hidden;
			overflow: hidden;
			transition: block-size var(--tc-item-trsdu), content-visibility var(--tc-item-trsdu);
			transition-behavior: allow-discrete;
		}
	}

	/*
	 ************************************
	 * 5. TABS TRANSFORMATION (`to` attribute)
	 ************************************
	 *
	 * When the `to` attribute is present and the container is wide enough (>= 700px),
	 * the component transforms into a tabbed interface. This section primarily handles
	 * resetting the accordion styles from the `from` variants to a neutral state
	 * before the main tab styles are applied.
	 *
	 */
	:scope[to] {
		@container (width >= 700px) {

			cq-box {
				background: unset;
				grid-template-columns: repeat(var(--tab-cordion-tabs, 6), 1fr);
				grid-template-rows: auto 1fr;
				isolation: isolate;
				padding: 0;
				position: relative;
				row-gap: 0;
				&::after {
					box-sizing: border-box;
					content: "";
					display: block;
					grid-row: 1;
					position: absolute;
					inset-block-start: var(--tc-tabs-bdw);
					inset-inline-start: calc(anchor(--tab-active left) + var(--tc-tabs-bdw));
					/* Sliding highlight tracks the anchored active summary. */
					inline-size: calc(anchor-size(--tab-active width) - (2 * var(--tc-tabs-bdw)));
					block-size: calc(anchor-size(--tab-active height) - (2 * var(--tc-tabs-bdw)));
					transition: inset-inline-start var(--tc-item-trsdu) ease, inline-size var(--tc-item-trsdu) ease;
				}
			}

			details,
			details:first-of-type,
			details:last-of-type {
				border: 0;
				border-block-start: 0;
				border-radius: 0;
				box-shadow: none;
				display: grid;
				grid-column: 1 / -1;
				grid-row: 1 / span 2;
				grid-template-columns: subgrid;
				grid-template-rows: subgrid;
				pointer-events: none;
				translate: none;
				&[open] summary {
					anchor-name: --tab-active;
				}
			}

			details::details-content {
				grid-column: 1 / -1;
				grid-row: 2;
				pointer-events: auto;
				/* Ensures the body spans the full tab row beneath the summaries. */
			}

			summary,
			details:first-of-type summary,
			details:last-of-type summary,
			details[open] + details summary,
			details:has(+ details[open]) summary {
				--tc-item-p: var(--tc-item-p-tabs);
				align-items: center;
				border-radius: 0;
				display: flex;
				gap: 1ch;
				justify-content: center;
				pointer-events: auto;
				text-align: center;
				transition: color var(--tc-item-trsdu), background-color var(--tc-item-trsdu);
				z-index: 1;
				& + * {  pointer-events: auto; position: relative; z-index: 1; }
			}

			@media (hover: hover) {
				/* Disable additional hover growth so the highlight remains visible. */
				details:hover,
				&:not([from~="nohover"]) details:hover:not([open]) {
					background: #0000;
				}
				&:not([to~="nohover"]) {
					summary:hover {
						color: var(--tc-tab-hover-c);
						cursor: pointer;
						text-decoration: var(--tc-tab-hover-td);
					}
					details:not([open]) summary:hover {
						background: var(--tc-tab-hover-bg);
						/* Background shape follows the summary's border-radius (square by default, rounded if [to~="rounded"]) */
					}
				}
			}

			/* --- Add main background and reset background properties for tabs --- */
			&[to~="background"] {
				cq-box::before {
					background: var(--tc-tabs-bg);
					content: "";
					grid-column: 1 / -1;
					grid-row: 1;
				}
				details { background: unset; }
			}

			/* --- `compact` tabs compress headers to intrinsic widths --- */
			&[to~="compact"] {
				cq-box {
					column-gap: var(--tc-tabs-gap, 2ch);
					grid-template-columns: repeat(calc(var(--tab-cordion-tabs, 6) - 1), min-content) auto;
				}
				details:last-of-type summary {
					justify-self: start;
				}
			}

			/* --- `highlight` draws a sliding pill behind the active summary --- */
			&[to~="highlight"] {
				cq-box::after {
					background: var(--tc-item-bg-active);
					border: var(--tc-tabs-item-bdw) solid var(--tc-tabs-item-bdc);
				}
			}

			/* --- `line` switches to an underline indicator instead of a pill --- */
			&[to~="line"] {
				cq-box::after {
					--tc-tabs-bdw: 0px;
					border-block-end: var(--tc-tabs-line-bdw, 3px) solid var(--tc-accent);
				}
				summary {
					justify-self: center;
					padding-inline: 0;
				}
			}

			/* --- `noicons` hides icons in summaries --- */
			&[to~="noicons"] {
				summary ui-icon {
					display: none;
				}
			}

			/* --- `panel-bg` applies a shared surface color to tab header + panel --- */
			&[to~="panel-bg"] {
				summary + * {
					background: var(--tc-tabs-panel-bg, #f7f7f7);
				}
			}

			/* --- `rounded` keeps pill/headers rounded in desktop mode --- */
			&[to~="rounded"] {
				cq-box::before {
					border-radius: var(--tc-tabs-bdrs);
				}
				cq-box::after {
					border-radius: calc(var(--tc-tabs-bdrs) - var(--tc-tabs-bdw));
				}
				summary,
				details:first-of-type summary,
				details:last-of-type summary,
				details[open] + details summary,
				details:has(+ details[open]) summary {
					border-radius: var(--tc-tabs-bdrs);
				}
			}

			/* --- `shadow` adds an elevated drop shadow under the active panel --- */
			&[to~="shadow"] {
				summary + * {
					box-shadow: var(--tc-tabs-panel-bxsh, 0 8px 18px -12px rgba(0, 0, 0, .35), 0 6px 12px -14px rgba(0, 0, 0, .2));
				}
			}
		}

		@media (prefers-color-scheme: dark) {
			summary + * {
				--tc-tabs-panel-bxsh: var(--tc-tabs-panel-bxsh-dark);
			}
		}
	}

	/*
	 ************************************
	 * 6. STATE PROPAGATION
	 ************************************
	 *
	 * 1. Assigns an index to each item (fallback for sibling-index()).
	 * 2. Counts the total number of items and sets it on the parent.
	 *
	 * This "bubbles up" state from children to a parent for use in other selectors.
	 * This is limited to 8 items but can be extended.
	*/

	details:nth-child(1) { --tab-cordion-index: 1; }
	details:nth-child(2) { --tab-cordion-index: 2; }
	details:nth-child(3) { --tab-cordion-index: 3; }
	details:nth-child(4) { --tab-cordion-index: 4; }
	details:nth-child(5) { --tab-cordion-index: 5; }
	details:nth-child(6) { --tab-cordion-index: 6; }
	details:nth-child(7) { --tab-cordion-index: 7; }
	details:nth-child(8) { --tab-cordion-index: 8; }

	cq-box:has(> details:nth-child(1):last-child) { --tab-cordion-tabs: 1; }
	cq-box:has(> details:nth-child(2):last-child) { --tab-cordion-tabs: 2; }
	cq-box:has(> details:nth-child(3):last-child) { --tab-cordion-tabs: 3; }
	cq-box:has(> details:nth-child(4):last-child) { --tab-cordion-tabs: 4; }
	cq-box:has(> details:nth-child(5):last-child) { --tab-cordion-tabs: 5; }
	cq-box:has(> details:nth-child(6):last-child) { --tab-cordion-tabs: 6; }
	cq-box:has(> details:nth-child(7):last-child) { --tab-cordion-tabs: 7; }
	cq-box:has(> details:nth-child(8):last-child) { --tab-cordion-tabs: 8; }
}

/*
 ************************************
 * 7. FIXES FOR DETAILS CONTENT GRID ISSUES
 ************************************
 *
 * Workarounds for current limitations in how <details> content is handled in grid layouts.
 *
 */
@supports (background: -webkit-named-image(i)) {
	details[open]::details-content {
		display: contents;
	}
	details > summary + * {
		grid-column: 1 / -1;
		grid-row: 2;
		pointer-events: auto;
	}
}