<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Variables Extractor</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 16px;
      background-color: #f5f5f5;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    button {
      background-color: #18a0fb;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-bottom: 12px;
    }

    button:hover {
      background-color: #0d7ce8;
    }

    .secondary {
      background-color: #ccc;
      color: #333;
    }

    .secondary:hover {
      background-color: #bbb;
    }

    .status {
      color: #666;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <button onclick="exportW3CTokens()">Export W3C Tokens</button>
  <button onclick="document.getElementById('fileInput').click()" class="secondary">Import W3C Tokens</button>
  <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileUpload(event)">
  <button onclick="closePlugin()" class="secondary">Close</button>
  <div id="status" class="status">Ready to export or import.</div>

  <script>
    let figmaData = null;

    window.onmessage = (event) => {
      const { type, data } = event.data.pluginMessage;
      if (type === 'variables-data') {
        figmaData = data;
        document.getElementById('status').textContent = 'Variable data loaded. Ready to export.';
      }
      if (type === 'export-ready') {
          const dataStr = JSON.stringify(data, null, 2);
          const dataBlob = new Blob([dataStr], { type: 'application/json' });
          const url = URL.createObjectURL(dataBlob);
          const link = document.createElement('a');
          link.href = url;
          link.download = 'design-tokens.json';
          link.click();
          URL.revokeObjectURL(url);
          document.getElementById('status').textContent = 'Done! File exported successfully.';
      }
    };

    function exportW3CTokens() {
      if (!figmaData) {
        document.getElementById('status').textContent = 'Variable data not loaded yet. Please wait.';
        return;
      }
      document.getElementById('status').textContent = 'Exporting...';
      parent.postMessage({ pluginMessage: { type: 'export-w3c-tokens', data: figmaData } }, '*');
    }

    function closePlugin() {
      parent.postMessage({ pluginMessage: { type: 'close-plugin' } }, '*');
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Check file extension
      if (!file.name.toLowerCase().endsWith('.json')) {
        document.getElementById('status').textContent = 'Error: Only JSON files are allowed.';
        return;
      }

      // Also check MIME type as additional validation
      if (file.type && file.type !== 'application/json') {
        document.getElementById('status').textContent = 'Error: Only JSON files are allowed.';
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedData = JSON.parse(e.target.result);
          document.getElementById('status').textContent = 'Comparing tokens...';
          parent.postMessage({ pluginMessage: { type: 'import-w3c-tokens', data: importedData } }, '*');
        } catch (error) {
          console.error('Error parsing JSON:', error);
          document.getElementById('status').textContent = 'Error: Invalid JSON file.';
        }
      };
      reader.readAsText(file);
    }

    window.addEventListener('load', () => {
      document.getElementById('status').textContent = 'Loading variables...';
      parent.postMessage({ pluginMessage: { type: 'get-variables' } }, '*');
    });
  </script>
</body>
</html>