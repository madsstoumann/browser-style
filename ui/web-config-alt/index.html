<!DOCTYPE html>
<html lang="en-US" dir="ltr">
<head>
	<title>Web Config Alt</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
	<meta name="description" content="Web Config Alt - AI-powered alt text generator for images">
	<meta name="view-transition" content="same-origin">
	<link rel="stylesheet" href="/ui/base/index.css">
	<script type="importmap">
		{
			"imports": {
				"@browser.style/web-config-shared": "../web-config-shared/index.js"
			}
		}
	</script>
</head>
<body>
	<h1>Web Config: Alt Text</h1>
	<p>AI-powered alt text generator for images. Provide an image URL and generate descriptive alt text at different detail levels.</p>

	<fieldset style="margin-block-end:2ch;">
		<label>
			Worker URL
			<input type="url" id="workerUrl" placeholder="https://your-worker.workers.dev" value="http://localhost:8787">
		</label>
		<label>
			API Key
			<input type="password" id="apiKey" placeholder="Enter your API key">
		</label>
		<label>
			Image URL
			<input type="url" id="imageSrc" placeholder="https://example.com/photo.jpg" value="https://picsum.photos/id/237/400/300.jpg">
		</label>
	</fieldset>
	

	<web-config-alt id="editor"></web-config-alt>

	<script type="module">
		import './src/index.js';

		const editor = document.getElementById('editor');
		const workerUrlInput = document.getElementById('workerUrl');
		const apiKeyInput = document.getElementById('apiKey');
		const imageSrcInput = document.getElementById('imageSrc');

		workerUrlInput.value = localStorage.getItem('wca-worker-url') || workerUrlInput.value;
		apiKeyInput.value = localStorage.getItem('wca-api-key') || '';

		function update() {
			localStorage.setItem('wca-worker-url', workerUrlInput.value);
			localStorage.setItem('wca-api-key', apiKeyInput.value);
			editor.src = imageSrcInput.value;
		}

		workerUrlInput.addEventListener('input', update);
		apiKeyInput.addEventListener('input', update);
		imageSrcInput.addEventListener('input', update);

		editor.addEventListener('change', (e) => {
			console.log('Alt text changed:', e.detail);
		});

		editor.addEventListener('requestGenerate', async (e) => {
			const workerUrl = workerUrlInput.value;
			const apiKey = apiKeyInput.value;
			const src = imageSrcInput.value;

			console.log('[requestGenerate]', { workerUrl, apiKey: apiKey ? '***' : '(empty)', src, detail: e.detail.detail });

			if (!workerUrl || !src) {
				editor.showError('Worker URL and Image URL are required.');
				editor.generating = false;
				return;
			}

			try {
				const endpoint = workerUrl.replace(/\/+$/, '') + '/analyze';
				const response = await fetch(endpoint, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'X-API-Key': apiKey
					},
					body: JSON.stringify({ url: src, detail: e.detail.detail })
				});

				if (!response.ok) throw new Error(`HTTP ${response.status}: ${await response.text()}`);

				const data = await response.json();
				console.log('[requestGenerate] Response:', data);
				editor.value = data.alt || data.text || data.result || JSON.stringify(data);
			} catch (err) {
				console.error('[requestGenerate] Error:', err);
				editor.showError(err.message);
			} finally {
				editor.generating = false;
			}
		});

		update();
	</script>
</body>
</html>
