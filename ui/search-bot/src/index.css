/* --- Host --- */

:host * { box-sizing: border-box; }
:host {
	--sbot-bdc: light-dark(hsl(220 15% 85%), hsl(220 10% 50%));
	--sbot-btn-bg: light-dark(hsl(215 20% 90%), hsl(215 15% 22%));
	--sbot-btn-bg-hover: light-dark(hsl(215 20% 82%), hsl(215 15% 30%));
	--sbot-chatbot-bxsh: light-dark(0 8px 32px hsl(220 15% 30% / 0.18), 0 8px 32px hsl(0 0% 0% / 0.4));
	--sbot-chatbot-offset: 5rem;
	--sbot-code-bg: light-dark(hsl(220 15% 88%), hsl(220 10% 20%));
	--sbot-conversation-mxw: 70ch;
	--sbot-fieldset-bg: light-dark(Field, hsl(220 12% 15%));
	--sbot-gap: 12px;
	--sbot-header-bg: light-dark(#FFF, #333);
	--sbot-history-bg: light-dark(hsl(220 15% 98% / 0.95), hsl(220 15% 14% / 0.95));
	--sbot-history-bxsh: light-dark(0 4px 12px hsl(220 15% 30% / 0.12), 0 4px 12px hsl(0 0% 0% / 0.3));
	--sbot-history-delete-bg: light-dark(hsl(220 15% 88%), hsl(220 10% 22%));
	--sbot-history-delete-bg-hover: light-dark(hsl(220 15% 78%), hsl(220 10% 32%));
	--sbot-hover-bg: light-dark(hsl(220 15% 88%), hsl(220 10% 18%));
	--sbot-img-bgc: light-dark(hsl(220 10% 90%), hsl(220 10% 20%));
	--sbot-link-c: light-dark(hsl(215 80% 40%), hsl(215 70% 65%));
	--sbot-overlay-backdrop: light-dark(hsl(220 15% 96% / 0.95), hsl(220 15% 10% / 0.9));
	--sbot-scrollbar-thumb: light-dark(hsl(220 10% 75%), hsl(220 10% 30%));
	--sbot-trigger-offset: 1rem;
	--sbot-user-bgc: light-dark(hsl(220 10% 90%), hsl(215 25% 22%));
	color-scheme: light dark;
	font-family: var(--sbot-ff, 'Iowan Old Style', 'Palatino Linotype', 'URW Palladio L', P052, serif);
	scrollbar-color: var(--sbot-scrollbar-thumb) var(--sbot-scrollbar-track, transparent);
	scrollbar-width: thin;
}

/* --- Trigger --- */

[part="search-trigger"] { anchor-name: --sbot-trigger; display: grid; }
:host(:not([position="inline"])) [part="search-trigger"] { position: fixed; }
:host([position*="top"]) [part="search-trigger"]    { inset-block-start: var(--sbot-trigger-offset); }
:host([position*="bottom"]) [part="search-trigger"] { inset-block-end: var(--sbot-trigger-offset); }
:host([position*="left"]) [part="search-trigger"]   { inset-inline-start: var(--sbot-trigger-offset); }
:host([position*="right"]) [part="search-trigger"]  { inset-inline-end: var(--sbot-trigger-offset); }

/* --- Overlay --- */

[part="search-overlay"] {
	background: var(--sbot-overlay-bg, #0000);
	border: 1px solid var(--sbot-bdc);
	border-radius: 0;
	container-type: inline-size;
	font-size: 1rem;
	height: 100%;
	interpolate-size: allow-keywords;
	margin: 0;
	max-height: 100%;
	max-width: 100%;
	opacity: 1;
	overflow: clip;
	padding: 0;
	position-anchor: --sbot-trigger;
	width: 100%;

	@media (prefers-reduced-motion: no-preference) {
		transition:
			border-radius var(--sbot-morph-speed, 0.4s) var(--sbot-morph-ease, ease),
			display var(--sbot-morph-speed, 0.4s) allow-discrete,
			height var(--sbot-morph-speed, 0.4s) var(--sbot-morph-ease, ease),
			left var(--sbot-morph-speed, 0.4s) var(--sbot-morph-ease, ease),
			opacity var(--sbot-morph-speed, 0.4s) var(--sbot-morph-ease, ease),
			overlay var(--sbot-morph-speed, 0.4s) allow-discrete,
			top var(--sbot-morph-speed, 0.4s) var(--sbot-morph-ease, ease),
			width var(--sbot-morph-speed, 0.4s) var(--sbot-morph-ease, ease);
	}

	&[open] { align-content: start; display: grid; overflow: visible; }

	@starting-style {
		&[open] {
			border-radius: 50%;
			height: anchor-size(height);
			opacity: 0;
			width: anchor-size(width);
		}
	}

	&:not([open]) {
		border-radius: 50%;
		height: anchor-size(height);
		opacity: 0;
		width: anchor-size(width);
	}

	&::backdrop {
		background: var(--sbot-overlay-backdrop);
		backdrop-filter: var(--sbot-overlay-bdf, blur(20px) saturate(180%));
		@media (prefers-reduced-motion: no-preference) {
			transition:
				backdrop-filter var(--sbot-morph-speed, 0.4s) calc(var(--sbot-morph-speed, 0.4s) * 0.5),
				background var(--sbot-morph-speed, 0.4s) calc(var(--sbot-morph-speed, 0.4s) * 0.5),
				display var(--sbot-morph-speed, 0.4s) allow-discrete,
				overlay var(--sbot-morph-speed, 0.4s) allow-discrete;
			@starting-style { background: #0000; backdrop-filter: none; }
		}
	}
}

/* --- Search mode: anchor to trigger position --- */

:host(:not([mode="chatbot"])) [part="search-overlay"] {
	@starting-style {
		&[open] { border-radius: var(--sbot-icon-sz, 2em); left: anchor(left); top: anchor(top); }
	}
	&:not([open]) { border-radius: var(--sbot-icon-sz, 2em); left: anchor(left); top: anchor(top); }
}

/* --- Header & History --- */

[part="search-header"] {
	background: var(--sbot-header-bg);
	border-block-end: 1px solid var(--sbot-bdc);
	border-start-end-radius: inherit;
	border-start-start-radius: inherit;
	display: flex;
	align-items: center;
	gap: calc(var(--sbot-gap) / 2);
	padding: var(--sbot-gap);
}
[part="search-history"] { anchor-name: --sbot-history; }
[part="search-close"] { margin-inline-start: auto; }

[part="search-history-panel"] {
	background: var(--sbot-history-bg);
	backdrop-filter: var(--sbot-history-bdf, blur(8px));
	border: 1px solid var(--sbot-bdc);
	border-radius: var(--sbot-history-bdrs, 0.5rem);
	box-shadow: var(--sbot-history-bxsh);
	margin: 0;
	max-block-size: var(--sbot-history-mxbs, 60vh);
	max-inline-size: var(--sbot-history-mxis, 20rem);
	overflow-y: auto;
	padding: 0.5rem;
	position-anchor: --sbot-history;
	position-area: block-end span-inline-end;
}

[part="search-history-list"] {
	list-style: none;
	margin: 0;
	padding: 0;
	li[data-key] {
		align-items: center;
		border-radius: 0.25rem;
		cursor: pointer;
		display: grid;
		gap: calc(var(--sbot-gap) / 2);
		grid-template-columns: 1fr auto;
		padding: calc(var(--sbot-gap) / 2) var(--sbot-gap);
		span { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
	}
}

[part="search-history-delete"] {
	aspect-ratio: 1;
	background: var(--sbot-history-delete-bg);
	border: 0;
	border-radius: 0.25rem;
	cursor: pointer;
	display: inline-grid;
	place-content: center;
}
:host(:not([preserve-history])) [part="search-history"] { display: none; }

/* --- Conversation & Messages --- */

[part="search-conversation"] {
	flex: 1;
	list-style: none;
	margin: 0;
	overflow-y: auto;
	padding-block: var(--sbot-gap);
	padding-inline: max(var(--sbot-gap), calc(50% - var(--sbot-conversation-mxw) / 2));
}
[part="search-conversation"]:empty { display: none; }

[part="user"],
[part="response"] { padding: 0.75em 0; }

[part="user"] {
	background-color: var(--sbot-user-bgc);
	border-radius: var(--sbot-user-bdrs, 0.75rem);
	justify-self: end;
	max-width: 80%;
	padding: var(--sbot-user-p, 0.625rem 1rem);
}

[part="response"] {
	ul {
		display: grid;
		list-style: none;
		padding: 1em 0;
		row-gap: var(--sbot-response-ul-rg, 2ch);
		@container (min-width: 500px) {
			li a:has(img) { grid-template-columns: var(--sbot-response-img-is, auto) 1fr; }
		}
		li {
			display: contents;
			a {
				display: grid;
				column-gap: var(--sbot-gap);
				row-gap: calc(var(--sbot-gap) / 2);
				text-decoration: none;
				small, strong { display: block; }
				small { color: initial; }
				strong { text-decoration: underline; }
			}
		}
	}
	code {
		background: var(--sbot-code-bg);
		border-radius: 0.25em;
		font-family: var(--sbot-code-ff, monospace);
		padding: 0.1em 0.3em;
	}
	a { color: var(--sbot-link-c); }
}

[part~="pending"]::before {
	animation: l3 1s infinite linear;
	aspect-ratio: 2;
	--_g: no-repeat radial-gradient(circle closest-side, currentColor 90%, #0000);
	background: var(--_g) 0% 50%, var(--_g) 50% 50%, var(--_g) 100% 50%;
	background-size: calc(100%/3) 50%;
	content: "";
	display: block;
	width: 45px;
}
@keyframes l3 {
	20%  { background-position: 0% 0%, 50% 50%, 100% 50% }
	40%  { background-position: 0% 100%, 50% 0%, 100% 50% }
	60%  { background-position: 0% 50%, 50% 100%, 100% 0% }
	80%  { background-position: 0% 50%, 50% 50%, 100% 100% }
}

[part="search-result-img"] {
	background-color: var(--sbot-img-bgc);
	display: block;
	max-inline-size: var(--sbot-img-mxis, 200px);
}

[part="search-feedback"] {
	display: flex;
	gap: calc(var(--sbot-gap) / 2);
	padding-block-start: 0.5rem;
	button {
		background: none;
		border: 1px solid var(--sbot-bdc);
		border-radius: 0.25rem;
		cursor: pointer;
		padding: 0.25rem;
		svg { block-size: 1em; inline-size: 1em; }
		&[aria-pressed="true"] { background: var(--sbot-btn-bg); }
	}
}

/* --- Form --- */

[part="search-form"] {
	bottom: 0;
	padding-block: var(--sbot-gap);
	padding-inline: max(var(--sbot-gap), calc(50% - var(--sbot-conversation-mxw) / 2));
	position: sticky;
}

[part="search-fieldset"] {
	all: unset;
	background: var(--sbot-fieldset-bg);
	border: 1px solid var(--sbot-bdc);
	border-radius: var(--sbot-input-bdrs, 1ch);
	column-gap: var(--sbot-gap);
	display: grid;
	font: inherit;
	grid-template-columns: auto max-content;
	padding: var(--sbot-input-p, 1ch 2ch);
}
[part="search-legend"] { all: unset; text-align: center; }
[part="search-input"] { background: #0000; border: 0; color: FieldText; field-sizing: content; font: inherit; outline: none; padding-block-end: 1.5ch; resize: none; }

/* --- Icons & Buttons --- */

svg { block-size: var(--sbot-icon-sz, 2em); fill: none; inline-size: var(--sbot-icon-sz, 2em); stroke: currentColor; stroke-linecap: round; stroke-linejoin: round; stroke-width: 2; }
[part="search-trigger"] svg,
[part="search-feedback"] svg,
[part="search-stop"] svg { fill: currentColor; stroke: none; }

button[part]:has(svg) {
	aspect-ratio: 1;
	background: var(--sbot-btn-bg);
	border: 0;
	border-radius: 50%;
	display: inline-grid;
	place-items: center;
	&[hidden] { display: none; }
}

/* --- Hover --- */

@media (hover: hover) {
	button[part]:has(svg):hover { background: var(--sbot-btn-bg-hover); }
	[part="search-history-list"] li:hover { background: var(--sbot-hover-bg); }
	[part="search-history-delete"]:hover { background: var(--sbot-history-delete-bg-hover); }
	[part="search-feedback"] button:hover { background: var(--sbot-hover-bg); }
}

/* --- Overlay Mode --- */

:host([mode="overlay"]) [part="search-overlay"] {
	background: #FFF; /* TODO */
	border-radius: var(--sbot-overlay-bdrs, 1rem);
	box-shadow: var(--sbot-chatbot-bxsh);
	grid-template-rows: auto 1fr auto;
	height: var(--sbot-overlay-h, 85dvh);
	left: calc((100vw - var(--sbot-overlay-w, 85vw)) / 2);
	overflow: clip;
	top: calc((100dvh - var(--sbot-overlay-h, 85dvh)) / 2);
	width: var(--sbot-overlay-w, 85vw);
	&:has(ol:empty) { height: max-content; }
}

/* --- Chatbot Mode --- */

:host([mode="chatbot"]) [part="search-overlay"] {
	background: var(--sbot-overlay-backdrop);
	border-radius: var(--sbot-chatbot-bdrs, 1rem);
	box-shadow: var(--sbot-chatbot-bxsh);
	height: var(--sbot-chatbot-bs, min(600px, 80vh));
	margin: 0;
	max-height: 80vh;
	max-width: 90vw;
	position: fixed;
	width: var(--sbot-chatbot-is, min(400px, 90vw));
	@media (prefers-reduced-motion: no-preference) {
		transition:
			border-radius var(--sbot-morph-speed, 0.4s) var(--sbot-morph-ease, ease),
			bottom var(--sbot-morph-speed, 0.4s) var(--sbot-morph-ease, ease),
			display var(--sbot-morph-speed, 0.4s) allow-discrete,
			height var(--sbot-morph-speed, 0.4s) var(--sbot-morph-ease, ease),
			left var(--sbot-morph-speed, 0.4s) var(--sbot-morph-ease, ease),
			opacity var(--sbot-morph-speed, 0.4s) var(--sbot-morph-ease, ease),
			overlay var(--sbot-morph-speed, 0.4s) allow-discrete,
			right var(--sbot-morph-speed, 0.4s) var(--sbot-morph-ease, ease),
			top var(--sbot-morph-speed, 0.4s) var(--sbot-morph-ease, ease),
			width var(--sbot-morph-speed, 0.4s) var(--sbot-morph-ease, ease);
	}
	@starting-style {
		&[open] {
			border-radius: 50%;
			height: anchor-size(height);
			opacity: 0;
			width: anchor-size(width);
		}
	}
	&:not([open]) {
		border-radius: 50%;
		height: anchor-size(height);
		opacity: 0;
		width: anchor-size(width);
	}
	&::backdrop { background: transparent; backdrop-filter: none; pointer-events: none; }
}
:host([mode="chatbot"][position*="bottom"]) [part="search-overlay"] {
	inset-block: auto var(--sbot-chatbot-offset);
	@starting-style { &[open] { bottom: anchor(bottom); } }
	&:not([open]) { bottom: anchor(bottom); }
}
:host([mode="chatbot"][position*="top"]) [part="search-overlay"] {
	inset-block: var(--sbot-chatbot-offset) auto;
	@starting-style { &[open] { top: anchor(top); } }
	&:not([open]) { top: anchor(top); }
}
:host([mode="chatbot"][position*="right"]) [part="search-overlay"] {
	inset-inline: auto 1rem;
	@starting-style { &[open] { right: anchor(right); } }
	&:not([open]) { right: anchor(right); }
}
:host([mode="chatbot"][position*="left"]) [part="search-overlay"] {
	inset-inline: 1rem auto;
	@starting-style { &[open] { left: anchor(left); } }
	&:not([open]) { left: anchor(left); }
}

/* --- Content stagger (fade in after morph) --- */

[part="search-header"],
[part="search-conversation"],
[part="search-form"] {
	@media (prefers-reduced-motion: no-preference) {
		transition: opacity calc(var(--sbot-morph-speed, 0.4s) * 0.5) ease calc(var(--sbot-morph-speed, 0.4s) * 0.7);
	}
}
dialog:not([open]) :is([part="search-header"], [part="search-conversation"], [part="search-form"]) { opacity: 0; }
@starting-style {
	dialog[open] :is([part="search-header"], [part="search-conversation"], [part="search-form"]) { opacity: 0; }
}

/* --- Options --- */
:host(:not([options~="close"])) [part="search-close"],
:host(:not([options~="history"])) [part="search-history"],
:host(:not([options~="new"])) [part="search-new"],
:host(:not([options~="submit"])) [part="search-submit"] { display: none; }

:host(:not([options~="divider"])) [part="search-header"] {
	background: #0000;
	border: 0;
}