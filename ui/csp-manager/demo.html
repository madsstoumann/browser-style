<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>CSP Manager - Demos</title>
	<link rel="stylesheet" href="/base.css">
	<script src="index.js" type="module"></script>
	<style>
		section {
			margin-block: 3rem;
			padding-block-end: 2rem;
			border-bottom: 1px solid #ccc;
		}
		section:last-of-type {
			border-bottom: none;
		}
		.demo-controls {
			display: flex;
			gap: 1rem;
			margin-block: 1rem;
		}
	</style>
</head>
<body>

	<h1>CSP Manager Demos</h1>
	<p>Various examples demonstrating the CSP Manager web component features.</p>

	<hr>

	<!-- Demo 1: Initial Policy with Evaluation -->
	<section>
		<h2>1. <code>initial-policy</code> with Evaluation</h2>
		<p>Initialize with a predefined policy and enable security evaluation (note the red borders on unsafe directives).</p>
		<div id="demo1-container"></div>
	</section>

	<!-- Demo 2: From String -->
	<section>
		<h2>2. <code>fromString()</code> Method</h2>
		<p>Parse a CSP string format and load it into the manager with evaluation enabled.</p>
		<div id="demo2-container"></div>
	</section>

	<!-- Demo 3: Get Policy and CSP String -->
	<section>
		<h2>3. <code>policy</code> and <code>cspString</code> Getters</h2>
		<p>Interact with the CSP manager below, then use the buttons to retrieve the current policy or copy the CSP string.</p>
		<csp-manager id="demo3-manager" evaluate></csp-manager>
		<div class="demo-controls">
			<button id="getPolicyBtn">Get Policy (Console)</button>
			<button id="getCspStringBtn">Copy CSP String to Clipboard</button>
		</div>
	</section>

	<!-- Demo 4: Danish Language with Multiple Severity Levels -->
	<section>
		<h2>4. <code>lang="da"</code> - Danish with Multiple Severity Levels</h2>
		<p>Eksempel p√• dansk sprog med forskellige sikkerhedsniveauer:</p>
		<ul>
			<li><strong>H√∏j (r√∏d):</strong> script-src med 'unsafe-inline' og 'unsafe-eval'</li>
			<li><strong>Medium (orange):</strong> style-src med https: wildcard</li>
			<li><strong>Sikker (gr√∏n):</strong> object-src og base-uri</li>
		</ul>
		<div id="demo4-container"></div>
	</section>

	<!-- Demo 5: Event Listener -->
	<section>
		<h2>5. <code>csp-change</code> Event Listener</h2>
		<p>Listen to changes and display the current policy in real-time (for CMS integration).</p>
		<p>Try adding or removing directives and values below - watch the event log update:</p>
		<csp-manager id="demo5-manager" evaluate></csp-manager>
		<details style="margin-block-start: 1rem;">
			<summary><strong>Event Log</strong> (last 5 events)</summary>
			<pre id="event-log" style="background: #f5f5f5; padding: 1rem; border-radius: 0.5rem; max-height: 300px; overflow-y: auto; font-size: 0.875rem;"></pre>
		</details>
	</section>

	<script>
		// Demo 1: Initial Policy with Evaluation
		const clientPolicy = {
			"script-src": {
				"added": ["'unsafe-inline'", "cdn.example.com"]
			},
			"style-src": {
				"added": ["https://fonts.googleapis.com"]
			},
			"font-src": {
				"added": ["https://fonts.gstatic.com"]
			},
			"img-src": {
				"added": ["https://images.unsplash.com"]
			},
			"connect-src": {
				"added": ["api.example.com", "wss://websocket.example.com"]
			}
		};

		const policyString = JSON.stringify(clientPolicy);
		const demo1Manager = document.createElement('csp-manager');
		demo1Manager.setAttribute('initial-policy', policyString);
		demo1Manager.setAttribute('evaluate', '');
		document.getElementById('demo1-container').appendChild(demo1Manager);

		// Demo 2: From String with Evaluation
		const cspString = `
			base-uri 'self';
			default-src 'self';
			frame-ancestors 'none';
			object-src 'none';
			script-src 'self' 'unsafe-inline' 'unsafe-eval' https://example.com;
			style-src 'self' 'unsafe-inline';
		`;

		const demo2Manager = document.createElement('csp-manager');
		demo2Manager.setAttribute('evaluate', '');
		document.getElementById('demo2-container').appendChild(demo2Manager);

		customElements.whenDefined('csp-manager').then(() => {
			demo2Manager.fromString(cspString);
		});

		// Demo 3: Policy and CSP String Getters
		document.getElementById('getPolicyBtn').addEventListener('click', () => {
			const cspManager = document.getElementById('demo3-manager');
			const currentPolicy = cspManager.policy;
			console.log('Current CSP Policy:', JSON.stringify(currentPolicy, null, 2));
		});

		document.getElementById('getCspStringBtn').addEventListener('click', () => {
			const cspManager = document.getElementById('demo3-manager');
			const cspString = cspManager.cspString.replace(/&lt;/g, '<').replace(/&gt;/g, '>');
			navigator.clipboard.writeText(cspString).then(() => {
				console.log('Copied to clipboard:', cspString);
				alert('CSP string copied to clipboard!');
			}).catch(err => {
				console.error('Failed to copy text: ', err);
			});
		});

		// Demo 4: Danish with Multiple Severity Levels
		const danishPolicy = {
			"base-uri": {
				"added": []  // Secure - will show green
			},
			"object-src": {
				"added": []  // Secure - 'none' by default, will show green
			},
			"script-src": {
				"added": ["'unsafe-inline'", "'unsafe-eval'", "https://cdn.example.com"]  // HIGH - will show red
			},
			"style-src": {
				"added": ["https:", "'unsafe-inline'"]  // HIGH - unsafe-inline + wildcard, will show red
			},
			"default-src": {
				"added": ["https:"]  // MEDIUM - wildcard, will show orange
			},
			"img-src": {
				"added": ["data:"]  // MEDIUM - data: URIs, will show orange
			}
		};

		const demo4Manager = document.createElement('csp-manager');
		demo4Manager.setAttribute('lang', 'da');
		demo4Manager.setAttribute('evaluate', '');
		demo4Manager.setAttribute('initial-policy', JSON.stringify(danishPolicy));
		document.getElementById('demo4-container').appendChild(demo4Manager);

		// Demo 5: Event Listener
		const demo5Manager = document.getElementById('demo5-manager');
		const eventLog = document.getElementById('event-log');
		const events = [];

		demo5Manager.addEventListener('csp-change', (e) => {
			const timestamp = new Date().toLocaleTimeString();

			// Log to console
			console.group(`üîî csp-change event at ${timestamp}`);
			console.log('Policy Object:', e.detail.policy);
			console.log('CSP String:', e.detail.cspString);
			if (e.detail.evaluations) {
				console.log('Evaluations:', e.detail.evaluations);
			}
			console.log('Full Event Detail:', e.detail);
			console.groupEnd();

			const eventData = {
				timestamp,
				policy: e.detail.policy,
				cspString: e.detail.cspString,
				hasEvaluations: !!e.detail.evaluations
			};

			// Add to beginning of array and keep only last 5
			events.unshift(eventData);
			if (events.length > 5) events.pop();

			// Display in log
			eventLog.textContent = events.map((evt, idx) =>
				`[${evt.timestamp}] Event #${events.length - idx}
Policy: ${JSON.stringify(evt.policy, null, 2)}
Has Evaluations: ${evt.hasEvaluations}
---`
			).join('\n\n');

			// Example: Send to CMS
			// cms.updateField('csp_policy', e.detail.policy);
			// cms.updateField('csp_header', e.detail.cspString);
		});
	</script>

</body>
</html>
